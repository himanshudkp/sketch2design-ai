generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String          @id
  name           String
  email          String
  emailVerified  Boolean         @default(false)
  image          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @default(now()) @updatedAt
  sessions       Session[]
  accounts       Account[]
  creditsLedgers CreditsLedger[]
  subscriptions  Subscription[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model CreditsLedger {
  id             String   @id @default(cuid())
  userId         String
  subscriptionId String
  amount         Float
  type           String
  reason         String?
  idempotencyKey String?
  meta           Json?
  createdAt      DateTime
  updatedAt      DateTime

  user         User         @relation(fields: [userId], references: [id])
  subscription Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId], map: "idx_creditsLedger_subscriptionId")
  @@index([userId], map: "idx_creditsLedger_userId")
  @@index([idempotencyKey], map: "idx_creditsLedger_idempotencyKey")
  @@map("credits_ledger")
}

model Subscription {
  id                    String   @id @default(cuid())
  userId                String
  polarCustomerId       String
  polarSubscriptionId   String
  productId             String?
  priceId               String?
  planCode              String?
  status                String
  currentPeriodEnd      BigInt?
  trialEndsAt           BigInt?
  cancelAt              BigInt?
  canceledAt            BigInt?
  seats                 Int?
  metadata              Json?
  creditsBalance        Int
  creditsGrantPerPeriod Int
  creditsRolloverLimit  Int
  lastGrantCursor       String?
  createdAt             DateTime
  updatedAt             DateTime

  user   User            @relation(fields: [userId], references: [id])
  ledger CreditsLedger[]

  @@index([userId], map: "idx_subscription_userId")
  @@index([polarSubscriptionId], map: "idx_subscription_polarSubscriptionId")
  @@index([status], map: "idx_subscription_status")
  @@map("subscription")
}

model Projects {
  id                  String   @id @default(cuid())
  userId              String
  title               String
  description         String?
  styleGuide          String?
  sketchesData        Json
  viewportData        Json?
  generatedDesignData Json?
  thumbnail           String?
  moodBoardImages     String[] @default([])
  inspirationImages   String[] @default([])
  lastModified        Int
  isPublic            Boolean?
  tags                String[] @default([])
  projectNumber       Int
  createdAt           DateTime
  updatedAt           DateTime

  @@index([userId], map: "idx_projects_userId")
  @@map("projects")
}

model ProjectCounters {
  id                String   @id @default(cuid())
  userId            String
  nextProjectNumber Int
  createdAt         DateTime
  updatedAt         DateTime

  @@index([userId], name: "by_projects_counters_userId")
  @@map("project_counters")
}
